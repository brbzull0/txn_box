# 1) set the Expect-CT
# 2) Explicitly turn on XSS protection (usually already present)
# 3) set X-XSS-Protection to prevent XSS attacks.

txn_box:
- when: creq
  do:
  # default Expect-CT policy.
  - var<ct-policy>: "report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\""
  - with: creq-host
    select:
    # yimg.com or any subdomain
    - tld: "yimg.com"
      do:
      - creq-field<Cookie>: NULL
      - with: "{*}"  # check subdomains
        select:
        - match: "u" # for this one, tweak the Expect CT policy.
          do:
            var<ct-policy>: "enforce" # set Expect-CT policy.

- when: ursp
  do:
  # if any Set-Cookie field has a Domain with yimg.com, clear the field.
  - with: ursp-field<Set-Cookie>::by-field
    for-each:
    - with: ...
      select:
      - rxp<nc>: "domain=(?:[^=]*[.])?yimg[.]com"
        do:
          ursp-field<...>: NULL

- when: prsp
  do:
  # set a referrer policy if not already present.
  - prsp-field<Referrer-Policy>: [ prsp-field<Referrer-Policy>, { else: "no-referrer-when-downgrade" } ]
  # For proxy response, fix up the cross site fields if it's TLS.
  - with: cssn-proto<tls>
    select:
    - prefix: "tls"
      do:
      - prsp-field<Expect-CT>: "max-age=31536000, {var<ct-policy>}"
      - prsp-field<X-XSS-Protection>: "1; mode=block"
      - prsp-field<X-Content-Type-Options>: "nosniff"


