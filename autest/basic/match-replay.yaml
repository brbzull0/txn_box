meta:
  version: "1.0"
  txn_box:
  - when: creq
    do:
    - var<swoc>: "base"
    - with: creq-host
      select:
      - tld: "one"
        do:
        - var<swoc>: "level 1"
        - creq-field<txnbox>: "One!"
        - with: "{*}"  # check subdomains
          select:
          - match: "u.example" # for this one, tweak the Expect CT policy.
            do:
              var<swoc>: "level 2"

  - when: prsp
    do:
    - prsp-field<txnbox>: var<swoc>

sessions:
- protocol: [ ipv4, tcp ]
  transactions:

  - all:
      headers:
        fields:
        - [ uuid, 1 ]
    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.one ]
        - [ uuid, 1 ]
    proxy-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.one ]
        - [ txnbox, "One!"]
        - [ uuid, 1 ]
    server-response:
      status: 200
      reason: OK
      content:
        size: 72
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]
        - [ uuid, 1 ]
    proxy-response:
      status: 200
      reason: OK
      content:
        size: 72
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]
        - [ txnbox, "level 1" ]
        - [ uuid, 1 ]

  # Check domain doesn't match.
  - client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.two/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.two ]
        - [ uuid, 2 ]
    proxy-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.two/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.two ]
        - [ uuid, 2 ]
    server-response:
      status: 200
      reason: OK
      content:
        size: 72
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]
        - [ uuid, 2 ]
    proxy-response:
      status: 200
      reason: OK
      content:
        size: 72
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]
        - [ txnbox, "base" ]
        - [ uuid, 2 ]

  - client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://u.example.one/config/settings.yaml"
      headers:
        fields:
        - [ Host, u.example.one ]
        - [ uuid, 3 ]
    proxy-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://u.example.one/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.one ]
        - [ txnbox, "One!"]
        - [ uuid, 3 ]
    server-response:
      status: 200
      reason: OK
      content:
        size: 72
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]
        - [ uuid, 3 ]
    proxy-response:
      status: 200
      reason: OK
      content:
        size: 72
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]
        - [ txnbox, "level 2" ]
        - [ uuid, 3 ]
